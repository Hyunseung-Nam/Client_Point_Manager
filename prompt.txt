[최우선 전제: 최소 변경 / 구조 유지]
- 이 작업은 “새로 만드는 프로젝트”가 아니라, 기존 CRM 코드베이스를 ‘보완’하는 것이다.
- 기존 폴더 구조, 파일명, 클래스명, UI 로딩 방식, 진입점(main.py), 이벤트 연결 패턴을 최대한 유지한다.
- 대규모 리네이밍/폴더 재구성/프레임워크 교체/대규모 설계 변경은 금지한다.
- 변경은 “기능 추가에 꼭 필요한 범위”로만 제한한다.
- 새로 파일을 추가해야 한다면 modules/ 아래에 최소 개수로 추가하고, 기존 파일을 우선 확장한다.
- 기존 public 함수/클래스 시그니처는 가능한 유지한다(호환성 우선).
- 동작이 동일해야 하는 기존 기능은 no-regression을 최우선으로 한다.

[UX 작업 범위(필수)]
- 이번 작업에는 “기능 구현”뿐 아니라 “사용자(사장님) 관점 UX 개선”이 포함된다.
- 단, UX 개선은 기존 구조/화면을 갈아엎지 않고, 아래 범위 내에서만 수행한다:
  1) 버튼/정보의 배치 재정렬(레이아웃 수정)
  2) 문구(라벨) 개선(사장님 언어로)
  3) 위험 행동(삭제/초기화 등) 격리(관리자 화면으로 이동 또는 숨김)
  4) 피드백 UX 추가(토스트/상태라벨/버튼 비활성/중복 클릭 방지)
  5) 기본값/포커스/탭 이동 등 현장 입력 흐름 최적화
- Qt Designer에서 추후 수정하기 쉽도록, 위젯은 레이아웃 기반으로 구성하고 objectName 규칙을 정리한다.

[UX 품질 기준]
- 클릭/입력 후 0.3초 이내에 화면 상태가 즉시 갱신되어야 한다(숫자/라벨/로그).
- 모든 주요 버튼은 상태가 명확해야 한다:
  - 선택 고객이 없으면 주요 버튼 비활성
  - 처리 중이면 버튼 잠금(중복 클릭 방지)
  - 포인트 부족이면 “포인트 사용” 비활성 + 안내
- 위험 행동(고객 삭제/데이터 초기화/복구)은 메인 화면에 두지 말고 관리자 화면으로 격리한다.
- 오류 메시지는 개발자 용어가 아닌 사용자 용어로 표시한다(예: “전화번호가 올바르지 않습니다”).
- 최근 기록 5줄은 메인에서 항상 보이며, 전체 기록은 별도 창/다이얼로그로 제공한다.

[핵심 UX 목표]
- 메인 화면에서 고객 목록을 엑셀처럼 테이블로 한눈에 보고, 클릭하면 우측 패널이 즉시 갱신된다.
- 입력은 “숫자 입력창 없이” 버튼 클릭(빨래+1 / 건조+1 / 빨래+건조+1 / 포인트 사용)로 끝낸다.
- 지급 필요(reward_needed)는 자동 계산(총합 기준)으로 표시한다.
- 포인트 “지급”은 자동 발급이 아니라, 사장님이 “지급 완료” 버튼을 눌러 확정한다(수동).
- 지급 완료 시 로그 저장 + (정책에 따라) 카운트 초기화/차감이 자동으로 수행된다.
- 되돌리기(Undo): 최근 1회 행동 취소를 지원한다(중복 클릭/실수 보호).
- 관리자 화면(별도 다이얼로그/탭)에서 월 통계 요약을 본다(그래프 없이 숫자 요약만).

[절대 하지 말 것(Non-goals)]
- 문자/카톡 알림 기능 없음
- 회원 시스템/로그인 없음
- 모바일 앱 없음
- 매출/정산 기능 없음
- 인터넷 서버 연동 없음
- 복잡한 그래프 대시보드 없음 (월 통계는 숫자 요약만)
- 프로그램이 “자동으로 포인트 발급”하지 않는다(반드시 사장님 수동 지급 버튼으로 확정)

[데이터 구조: JSON 로컬 저장]
- data/customers.json : dict 구조, key=phone(string)
- data/history.json : list 구조, append-only
- 파일 없으면 자동 생성
- 파일 손상(JSON 파싱 실패) 시: 기존 파일 백업(.broken_타임스탬프) 후 새 파일 생성 + 사용자 안내

customers.json (예시)
{
  "01012345678": {
    "name": "김사장",
    "memo": "현금 단골, 가족 4명",
    "created_at": "2025-10-03T14:22:10",
    "last_visit_at": "2026-01-12T11:03:40",
    "laundry": 14,
    "dry": 8,
    "total": 22,
    "points_remaining": 3,
    "reward_needed": true,
    "month_count": 5
  }
}

logs.json (예시 entry)
{
  "id": "uuid",
  "phone": "01012345678",
  "date": "2026-01-25T15:00:00",
  "type": "REWARD_GRANTED",  // VISIT_LAUNDRY, VISIT_DRY, VISIT_BUNDLE, POINT_USE, REWARD_GRANTED, MANUAL_GRANT, UNDO
  "points": 1,
  "reason": "누적 10회 달성",
  "laundry_before": 9,
  "dry_before": 1,
  "total_before": 10,
  "points_remaining_after": 4
}

[무결성 규칙]
- phone: 숫자만, 길이 10~11
- laundry/dry: 0 이상 정수
- total은 입력받지 않고 항상 laundry+dry로 재계산
- reward_needed = (total >= REWARD_THRESHOLD)  (기본 10)
- logs.json은 append-only(기존 로그 수정 금지)
- 중복 클릭 방지: 지급 완료 버튼을 연속 클릭해도 “한 번만 처리”되도록 UI 잠금 또는 최근 처리 타임스탬프 체크

[포인트/지급 정책]

- reward_needed는 total >= REWARD_THRESHOLD(기본 10)이 되면 true로 표시한다.

- total이 기준 이상이 되는 순간:
  → 포인트는 자동으로 1회 지급된다.
  → REWARD_GRANTED 로그가 즉시 기록된다.
  → 지급 사유는 기본값: "누적 10회 달성".
  → 지급 직전 laundry/dry/total 값을 로그에 기록한다.
  → 지급 후 카운트 초기화 정책은 상수로 분리하여 관리한다.
     (기본값: laundry=0, dry=0, total=0)

- 자동 지급 중에는 UI를 잠시 비활성화하여
  동일 이벤트가 중복 처리되지 않도록 한다.

- 관리자 화면에는 "포인트 수동 지급" 버튼이 별도로 존재한다.
  이는 예외 상황(VIP 서비스, 컴플레인 처리 등)에만 사용한다.

- 수동 지급 시:
  → 지급 포인트 수 입력
  → 지급 사유 필수 입력
  → MANUAL_GRANT 로그로 기록
  → 기본적으로 laundry/dry/total은 변경하지 않는다.

- 자동 지급과 수동 지급 모두 logs.json에 append-only 방식으로 기록된다.

[Undo(최근 기록 취소)]
- 마지막 행동 1회 취소:
  - 가장 최근 로그를 읽고 그 반대 연산을 적용
  - 취소도 UNDO 로그로 남김
  - 지급 완료 취소는 매우 위험하므로: MVP에서는 “최근 방문 입력/포인트 사용”까지만 Undo 지원하고, 지급 완료 Undo는 관리자에서만 가능(또는 아예 비활성)로 구현

[UI 요구사항]
- 메인 화면 2컬럼:
  - 좌측: 고객 테이블(QTableWidget/QTableView)
    컬럼: 이름, 전화번호, 잔여포인트, 이번달, 최근방문, 지급필요(배지/아이콘)
    헤더 클릭 정렬, 검색창 입력 시 즉시 필터
  - 우측: 선택 고객 상세 카드 + “원클릭 버튼”
    - 빨래 +1, 건조 +1, 빨래+건조 +1, 포인트 사용
    - 지급 필요 표시가 true일 때 “지급 완료” 버튼 강조(활성), false면 비활성
    - 최근 활동 내역 5줄 리스트 + “전체 기록 보기” 버튼
  - 하단: 되돌리기(Undo) 버튼, 관리자 버튼(톱니/관리자)

- 관리자 화면(별도 다이얼로그):
  - 월 선택(이번달/이전달)
  - 숫자 요약:
    - 이번달 입력횟수(빨래+건조 총합)
    - 포인트 지급 횟수(REWARD_GRANTED + MANUAL_GRANT)
    - 포인트 사용 횟수(POINT_USE)
    - 단골 비율(이번달 N회 이상 방문 고객 비율)
    - Top5(이번달 방문 기준)
    - 전월 대비 증감(각 지표)
  - 엑셀 내보내기는 옵션(당장 구현 제외 가능)

[아키텍처 / 코드 스타일]
- SOLID + MVP(또는 MVC) 준수: UI는 View, 로직은 Controller/Service, 저장은 Storage로 분리
- 함수명은 동사+대상: record_laundry, grant_reward, build_monthly_report 등
- 주석 규칙: 입력/출력/역할 표시
- No-regression: 기존 동작 유지하면서 기능 추가, UI 이벤트 연결은 controller에서만 처리
- 에러 처리: 사용자에게 QMessageBox로 안내 + 로깅(logger)

[필수 모듈]
- modules/validator.py: valid_phone, parse_int, non_negative
- modules/storage.py: ensure_files_exist, load_customers, save_customers, load_logs, append_log, backup_file
- modules/calculator.py:
  - recalc_customer_fields(customer)
  - compute_reward_needed(total)
  - remaining_until_reward(total)
  - build_monthly_report(customers, logs, month_key)
- modules/controller.py:
  - connect_events()
  - load_initial_data()
  - refresh_customer_table()
  - select_customer(phone)
  - update_customer_panel(phone)
  - record_laundry/record_dry/record_bundle/consume_point
  - grant_reward(phone)  // 수동 지급 확정 버튼
  - manual_grant(phone, points, reason)
  - undo_last_action(phone)
  - open_admin_dialog()
  - open_full_log_dialog(phone)

[테스트 시나리오(최소)]
- 신규 번호 검색 → 자동 생성 → 테이블에 반영
- 빨래+1 10회 → 지급 필요 true 표시
- 지급 완료 클릭 → 로그 1건 + 카운트 초기화 + 지급 필요 false
- 지급 완료 버튼 연타 → 로그 중복 생성/중복 초기화 안 됨
- 파일 손상(JSON 깨짐) → 백업 생성 + 새 파일 생성 + 안내
- 전화번호 이상 입력(문자/공백/길이) → 팝업 + 저장 불가

[Non-goals / 하지 않을 것]

- 프로그램은 고객에게 문자/알림을 보내지 않는다.
- 인터넷 서버 연동 없음.
- 매출/정산 기능 없음.
- 모바일 앱 없음.
- 로그인/회원 시스템 없음.
- 그래프 중심의 대시보드 없음.

※ 단, 포인트는 조건 달성 시 자동 지급되며,
   사장님은 별도로 버튼을 누를 필요가 없다.

[명명 통일]
- 로그 파일은 data/history.json 으로 통일하며, 코드 내 함수/변수도 history 용어를 사용한다.
(예: load_history, append_history, list_recent_history)

추가로, 변경 전/후 UX 차이를 설명하고(왜 이 배치가 더 빠르고 안전한지),
Qt Designer에서 수정해야 할 항목을 “구체적인 objectName 기준”으로 체크리스트 형태로 제시하라.


위 요구사항에 맞춰 기존 CRM 코드를 최소 변경으로 수정하는 작업 계획(파일별 변경점)과, Qt Designer(.ui)에서 ‘추가해야 하는 위젯 목록(objectName 포함)’을 빠짐없이 제시하고, controller/storage/calculator 중심의 함수 시그니처를 먼저 제시한 뒤, 그 다음 구현 코드를 작성하라.
